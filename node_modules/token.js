// TODO mongodb vs redis vs memcached?
// TODO to learn redis, when to use callback? doc node_redis
// psuedoRandomBytes is the same algorithm
// from http://stackoverflow.com/questions/18130254/randombytes-vs-pseudorandombytes



var crypto = require('crypto');
var redis = require('redis');


/**
 * Redis client
 */

var rcli = redis.createClient();

rcli.on('end', function () {
  rcli = redis.createClient();
});


/**
 * Redis key
 */

function getKey (ip, token) {
  
  return 'token:' + ip + ':' + token;

}


/**
 * get
 */

exports.get = function (ip, opts, callback) {

  opts = opts || {};

  crypto.randomBytes(48, function (ex, buf) {
    if (ex) throw ex;

    var token = buf.toString('base64');
    var key = getKey(ip, token);

    opts.tsn = Date.now();
    rcli.hmset(key, opts);

  });

  // put date, code, ip, captcha, expires
  // send code
  
};


/**
 * verify
 */

exports.verify = function (token, callback) {

  rcli.get(
  // delete when verify

};


///////////////////////

token.get(ip, function (err, token) {

});

token.verify(ip, token, function (err, results) {
  if (
});
